<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>L·ªçc ·∫¢nh Google Drive</title>
  <style>
    body { font-family: sans-serif; margin: 24px; max-width: 800px }
    h1 { font-size: 22px }
    .card { border: 1px solid #ccc; padding: 16px; border-radius: 12px; margin: 16px 0 }
    input, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; margin-top: 6px }
    button { padding: 10px 16px; border: none; border-radius: 8px; cursor: pointer; margin-top: 12px }
    .primary { background: #007bff; color: #fff }
    .secondary { background: #eee }
    .ok { color: green } .err { color: red }
  </style>
</head>
<body>
  <h1>üîç L·ªçc ·∫¢nh Google Drive</h1>

  <div class="card">
    <span id="authState">ƒêang ki·ªÉm tra ƒëƒÉng nh·∫≠p‚Ä¶</span>
    <a id="loginBtn" href="/api/auth" style="display:none"><button class="primary">ƒêƒÉng nh·∫≠p Google</button></a>
    <button id="logoutBtn" class="secondary" style="display:none">ƒêƒÉng xu·∫•t</button>
  </div>

  <div class="card">
    <label>Link th∆∞ m·ª•c g·ªëc:</label>
    <input type="text" id="sourceLink" placeholder="https://drive.google.com/drive/folders/xxxxx">
    <label>Danh s√°ch file (m·ªói d√≤ng / c√°ch b·ªüi d·∫•u ph·∫©y):</label>
    <textarea id="list" rows="6"></textarea>
    <button id="runBtn" class="primary">Ch·∫°y l·ªçc</button>
    <div id="status"></div>
  </div>

  <div id="result" class="card" style="display:none">
    <h3>K·∫øt qu·∫£</h3>
    <div><a id="resultLink" target="_blank">M·ªü th∆∞ m·ª•c m·ªõi</a></div>
    <p>ƒê√£ copy:</p><ul id="matched"></ul>
    <p>Kh√¥ng t√¨m th·∫•y:</p><ul id="notFound"></ul>
  </div>

<script>
async function refreshAuth() {
  const r = await fetch('/api/me', { credentials: 'include' });
  const j = await r.json();
  if (j.authed) {
    authState.textContent = "ƒê√£ ƒëƒÉng nh·∫≠p ‚úÖ";
    loginBtn.style.display = "none"; logoutBtn.style.display = "inline-block";
  } else {
    authState.textContent = "Ch∆∞a ƒëƒÉng nh·∫≠p";
    loginBtn.style.display = "inline-block"; logoutBtn.style.display = "none";
  }
}
logoutBtn.onclick = async()=>{await fetch('/api/logout',{method:'POST'});location.reload()};
runBtn.onclick = async()=>{
  status.textContent="ƒêang ch·∫°y‚Ä¶"; result.style.display="none";
  const r = await fetch('/api/filter',{method:'POST',headers:{'Content-Type':'application/json'},credentials:'include',
    body:JSON.stringify({sourceFolderLink:sourceLink.value,list:list.value})});
  const j = await r.json();
  if(!r.ok){status.innerHTML='<span class=err>'+j.error+'</span>';return}
  status.innerHTML='<span class=ok>Ho√†n t·∫•t!</span>'; result.style.display="block";
  resultLink.href=j.resultLink;
  matched.innerHTML=j.matched.map(n=>"<li>"+n+"</li>").join("");
  notFound.innerHTML=j.notFound.map(n=>"<li>"+n+"</li>").join("");
};
refreshAuth();
</script>
</body>
</html>
