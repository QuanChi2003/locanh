<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>L·ªçc ·∫¢nh Google Drive</title>
  <style>
    body { font-family: system-ui, Arial; margin: 24px; max-width: 820px }
    .card { border: 1px solid #ddd; padding: 16px; border-radius: 12px; margin: 16px 0 }
    input, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; }
    button { padding: 10px 16px; border: none; border-radius: 8px; cursor: pointer; margin-top: 12px }
    .primary { background: #111; color: #fff }
    .secondary { background: #eee }
    .ok { color: #0a7e07 } .err { color: #c00 }
  </style>
</head>
<body>
  <h1>üîç L·ªçc ·∫¢nh Google Drive</h1>

  <div class="card">
    <span id="authState">ƒêang ki·ªÉm tra ƒëƒÉng nh·∫≠p‚Ä¶</span>
    <a id="loginBtn" href="/api/auth" style="display:none"><button class="primary">ƒêƒÉng nh·∫≠p Google</button></a>
    <button id="logoutBtn" class="secondary" style="display:none">ƒêƒÉng xu·∫•t</button>
  </div>

  <div class="card">
    <label>Link th∆∞ m·ª•c g·ªëc (Google Drive)</label>
    <input id="sourceLink" placeholder="https://drive.google.com/drive/folders/xxxxxx">

    <label>Danh s√°ch file (m·ªói d√≤ng / d·∫•u ph·∫©y)</label>
    <textarea id="list" rows="7" placeholder="38UT.CR2
YO3715.CR3
ULG36.CR2
GG62.CR3"></textarea>

    <button id="runBtn" class="primary">Ch·∫°y l·ªçc</button>
    <div id="status"></div>
  </div>

  <div id="result" class="card" style="display:none">
    <h3>K·∫øt qu·∫£</h3>
    <div><a id="resultLink" target="_blank">M·ªü th∆∞ m·ª•c m·ªõi</a></div>
    <p>ƒê√£ copy:</p><ul id="matched"></ul>
    <p>Kh√¥ng t√¨m th·∫•y:</p><ul id="notFound"></ul>
  </div>

<script>
async function refreshAuth(){
  const r = await fetch('/api/me', { credentials: 'include' });
  const j = await r.json();
  if (j.authed) {
    authState.textContent = 'ƒê√£ ƒëƒÉng nh·∫≠p ‚úÖ';
    loginBtn.style.display = 'none'; logoutBtn.style.display = 'inline-block';
  } else {
    authState.textContent = 'Ch∆∞a ƒëƒÉng nh·∫≠p';
    loginBtn.style.display = 'inline-block'; logoutBtn.style.display = 'none';
  }
}
logoutBtn.onclick = async()=>{ await fetch('/api/logout', { method:'POST' }); location.reload(); };
runBtn.onclick = async()=>{
  status.textContent = 'ƒêang ch·∫°y‚Ä¶'; result.style.display='none';
  const r = await fetch('/api/filter', {
    method:'POST', headers:{'Content-Type':'application/json'}, credentials:'include',
    body: JSON.stringify({ sourceFolderLink: sourceLink.value, list: list.value })
  });
  const j = await r.json();
  if (!r.ok) { status.innerHTML = '<span class=err>'+ (j.error||'L·ªói') +'</span>'; return; }
  status.innerHTML = '<span class=ok>Ho√†n t·∫•t!</span>';
  result.style.display='block';
  resultLink.href = j.resultLink;
  matched.innerHTML = (j.matched || []).map(n=>`<li>${n}</li>`).join('');
  notFound.innerHTML = (j.notFound || []).map(n=>`<li>${n}</li>`).join('');
};
refreshAuth();
</script>
</body>
</html>
